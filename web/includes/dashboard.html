{{define "dashboard"}}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">Token Dashboard</h2>
                    <p class="text-muted">Manage your meme tokens and track performance</p>
                </div>
                <div>
                    <a href="/create-token" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus"></i> Create New Token
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-gradient-primary text-white shadow">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-uppercase mb-1">Total Tokens</div>
                            <div class="h5 mb-0 font-weight-bold" id="totalTokens">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-coins fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-gradient-success text-white shadow">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-uppercase mb-1">Deployed</div>
                            <div class="h5 mb-0 font-weight-bold" id="deployedTokens">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-rocket fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-gradient-info text-white shadow">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-uppercase mb-1">Total Value</div>
                            <div class="h5 mb-0 font-weight-bold" id="totalValue">$0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card bg-gradient-warning text-white shadow">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-uppercase mb-1">Total Holders</div>
                            <div class="h5 mb-0 font-weight-bold" id="totalHolders">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tokens Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Your Tokens</h6>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" 
                                data-bs-toggle="dropdown">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="filterTokens('all')">All Tokens</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterTokens('draft')">Drafts</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterTokens('deploying')">Deploying</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterTokens('deployed')">Deployed</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterTokens('failed')">Failed</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="tokensTable">
                            <thead>
                                <tr>
                                    <th>Token</th>
                                    <th>Symbol</th>
                                    <th>Network</th>
                                    <th>Status</th>
                                    <th>Supply</th>
                                    <th>Holders</th>
                                    <th>Market Cap</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tokensTableBody">
                                <!-- Tokens will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="text-center py-5" style="display: none;">
                        <i class="fas fa-coins fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No tokens found</h5>
                        <p class="text-muted">Create your first meme token to get started!</p>
                        <a href="/create-token" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Create Token
                        </a>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2">Loading your tokens...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Token Details Modal -->
<div class="modal fade" id="tokenModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tokenModalTitle">Token Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="tokenModalBody">
                <!-- Token details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="deployTokenBtn" style="display: none;">
                    <i class="fas fa-rocket"></i> Deploy Token
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.bg-gradient-success {
    background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
}

.bg-gradient-info {
    background: linear-gradient(135deg, #3498db 0%, #85c1e9 100%);
}

.bg-gradient-warning {
    background: linear-gradient(135deg, #f39c12 0%, #f7dc6f 100%);
}

.status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
}

.status-draft {
    background-color: #6c757d;
    color: white;
}

.status-deploying {
    background-color: #ffc107;
    color: black;
}

.status-deployed {
    background-color: #28a745;
    color: white;
}

.status-failed {
    background-color: #dc3545;
    color: white;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #5a5c69;
}

.card {
    border: none;
    border-radius: 0.75rem;
}

.btn-action {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    margin: 0 0.125rem;
}
</style>

<script>
let allTokens = [];
let currentFilter = 'all';

document.addEventListener('DOMContentLoaded', function() {
    loadTokens();
    loadStats();
});

async function loadTokens() {
    try {
        const response = await fetch('/api/user/tokens', {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            }
        });
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        allTokens = data.tokens || [];
        displayTokens(allTokens);
        updateStats(allTokens);
        
        document.getElementById('loadingState').style.display = 'none';
        
    } catch (error) {
        console.error('Error loading tokens:', error);
        document.getElementById('loadingState').innerHTML = 
            '<div class="alert alert-danger">Failed to load tokens</div>';
    }
}

function displayTokens(tokens) {
    const tbody = document.getElementById('tokensTableBody');
    const emptyState = document.getElementById('emptyState');
    
    if (!tokens || tokens.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    
    tbody.innerHTML = tokens.map(token => `
        <tr>
            <td>
                <div class="d-flex align-items-center">
                    ${token.image_url ? 
                        `<img src="${token.image_url}" alt="${token.name}" class="rounded-circle me-2" width="32" height="32">` :
                        `<div class="bg-primary rounded-circle me-2 d-flex align-items-center justify-content-center text-white" style="width: 32px; height: 32px; font-size: 14px;">${token.symbol ? token.symbol.charAt(0) : 'T'}</div>`
                    }
                    <div>
                        <div class="fw-bold">${token.name}</div>
                        ${token.description ? `<small class="text-muted">${token.description.substring(0, 50)}${token.description.length > 50 ? '...' : ''}</small>` : ''}
                    </div>
                </div>
            </td>
            <td><code>${token.symbol}</code></td>
            <td>
                <span class="badge bg-secondary">${token.network.toUpperCase()}</span>
            </td>
            <td>
                <span class="status-badge status-${token.status}">${token.status.toUpperCase()}</span>
            </td>
            <td>${formatNumber(token.total_supply)}</td>
            <td>${token.analytics ? formatNumber(token.analytics.holders) : '0'}</td>
            <td>${token.analytics ? '$' + formatNumber(token.analytics.market_cap) : '$0'}</td>
            <td>${formatDate(token.created_at)}</td>
            <td>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary btn-action" onclick="viewToken(${token.id})" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${token.status === 'draft' ? `
                        <button class="btn btn-outline-success btn-action" onclick="deployToken(${token.id})" title="Deploy">
                            <i class="fas fa-rocket"></i>
                        </button>
                        <button class="btn btn-outline-warning btn-action" onclick="editToken(${token.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-action" onclick="deleteToken(${token.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : token.contract_address ? `
                        <a href="https://etherscan.io/token/${token.contract_address}" target="_blank" class="btn btn-outline-info btn-action" title="View on Explorer">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    ` : ''}
                </div>
            </td>
        </tr>
    `).join('');
}

function updateStats(tokens) {
    const totalTokens = tokens.length;
    const deployedTokens = tokens.filter(t => t.status === 'deployed').length;
    const totalValue = tokens.reduce((sum, t) => sum + parseFloat(t.analytics?.market_cap || 0), 0);
    const totalHolders = tokens.reduce((sum, t) => sum + parseInt(t.analytics?.holders || 0), 0);
    
    document.getElementById('totalTokens').textContent = totalTokens;
    document.getElementById('deployedTokens').textContent = deployedTokens;
    document.getElementById('totalValue').textContent = '$' + formatNumber(totalValue);
    document.getElementById('totalHolders').textContent = formatNumber(totalHolders);
}

function filterTokens(status) {
    currentFilter = status;
    const filteredTokens = status === 'all' ? allTokens : allTokens.filter(t => t.status === status);
    displayTokens(filteredTokens);
}

function viewToken(tokenId) {
    const token = allTokens.find(t => t.id === tokenId);
    if (!token) return;
    
    document.getElementById('tokenModalTitle').textContent = token.name;
    document.getElementById('tokenModalBody').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Basic Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Name:</strong></td><td>${token.name}</td></tr>
                    <tr><td><strong>Symbol:</strong></td><td>${token.symbol}</td></tr>
                    <tr><td><strong>Network:</strong></td><td>${token.network}</td></tr>
                    <tr><td><strong>Total Supply:</strong></td><td>${formatNumber(token.total_supply)}</td></tr>
                    <tr><td><strong>Decimals:</strong></td><td>${token.decimals}</td></tr>
                    <tr><td><strong>Status:</strong></td><td><span class="status-badge status-${token.status}">${token.status.toUpperCase()}</span></td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Analytics</h6>
                <table class="table table-sm">
                    <tr><td><strong>Holders:</strong></td><td>${token.analytics ? formatNumber(token.analytics.holders) : '0'}</td></tr>
                    <tr><td><strong>Transactions:</strong></td><td>${token.analytics ? formatNumber(token.analytics.transactions) : '0'}</td></tr>
                    <tr><td><strong>Market Cap:</strong></td><td>$${token.analytics ? formatNumber(token.analytics.market_cap) : '0'}</td></tr>
                    <tr><td><strong>Price:</strong></td><td>$${token.analytics ? token.analytics.price : '0'}</td></tr>
                </table>
            </div>
        </div>
        ${token.description ? `<div class="mt-3"><h6>Description</h6><p>${token.description}</p></div>` : ''}
        ${token.contract_address ? `<div class="mt-3"><h6>Contract Address</h6><code>${token.contract_address}</code></div>` : ''}
    `;
    
    const deployBtn = document.getElementById('deployTokenBtn');
    if (token.status === 'draft') {
        deployBtn.style.display = 'inline-block';
        deployBtn.onclick = () => deployToken(tokenId);
    } else {
        deployBtn.style.display = 'none';
    }
    
    new bootstrap.Modal(document.getElementById('tokenModal')).show();
}

async function deployToken(tokenId) {
    if (!confirm('Are you sure you want to deploy this token? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/tokens/deploy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify({
                token_id: tokenId,
                network_id: 1 // Default to Ethereum
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        showNotification('Token deployment initiated!', 'success');
        loadTokens(); // Refresh the list
        
    } catch (error) {
        console.error('Error deploying token:', error);
        showNotification('Failed to deploy token: ' + error.message, 'error');
    }
}

async function deleteToken(tokenId) {
    if (!confirm('Are you sure you want to delete this token? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/tokens/${tokenId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            }
        });
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        showNotification('Token deleted successfully!', 'success');
        loadTokens(); // Refresh the list
        
    } catch (error) {
        console.error('Error deleting token:', error);
        showNotification('Failed to delete token: ' + error.message, 'error');
    }
}

function editToken(tokenId) {
    window.location.href = `/edit-token/${tokenId}`;
}

function formatNumber(num) {
    if (!num) return '0';
    const n = parseFloat(num);
    if (n >= 1e9) return (n / 1e9).toFixed(2) + 'B';
    if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
    if (n >= 1e3) return (n / 1e3).toFixed(2) + 'K';
    return n.toLocaleString();
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString();
}

function showNotification(message, type) {
    // Implementation depends on your notification system
    alert(message);
}

async function loadStats() {
    // Additional stats loading if needed
}
</script>
{{end}}